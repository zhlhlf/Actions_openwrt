name: Build OpenWrt

on:   
   workflow_dispatch:

    inputs:
      repo_url:
        description: 'repo_url'
        required: true
        default: 'https://github.com/immortalwrt/immortalwrt'

      repo_branch:
        description: 'repo_branch'
        required: false
        default: 'openwrt-24.10'

      edit_config:
        description: 'edit config'
        required: false
        default: 'mv .config openwrt/.config'

      diy_sh:
        description: 'diy_sh'
        required: false
        default: 'sh ../diy.sh'

      upload:
        description: '123 tyy2/short_time_files tyy2_crypt'
        required: false
        default: ''
        
env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 更改交换空间并link构建空间
      uses: zhlhlf/maximize-build-space@master
      with:
          swap-size-mb: 8192
                      
    - name: 获取本仓库源码
      uses: actions/checkout@main

    - name: 配置环境
      run: |
        sudo apt-get update
        sudo apt-get -y install dos2unix 
       
    - name: 获取源码&替换config
      run: |
        git clone --depth 1 ${{ inputs.repo_url }} -b ${{ inputs.repo_branch }} openwrt
        rm -rf $GITHUB_WORKSPACE/openwrt/.config
        ${{ inputs.edit_config }}
        # git clone https://github.com/zhlhlf/jczhl-package openwrt/package/jczhl
 
    - name: 更新并安装feeds
      run: |
         cd openwrt 
         ./scripts/feeds update -a
         ./scripts/feeds install -a
         find ./ -maxdepth 3 -type f -iregex ".*\(txt\|sh\)$" -exec dos2unix {} \; -exec chmod +x {} \;
        
    - name: 获取软件包
      run: |
        mkdir zhlhlf
        cd openwrt   
        make defconfig
        make download -j$(nproc)
        
        #清理垃圾文件
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
         
    - name: 一系列可自定义配置
      run: |
        cd openwrt
        ${{ inputs.diy_sh }}

    - name: 编译
      run: |
        cd openwrt
        FORCE_UNSAFE_CONFIGURE=1
        make -j$(nproc) || make -j1 || make -j1 V=s
                            
    - name: zip 打包
      run: |
         rm -rf openwrt/bin/targets/*/*/packages 
         find openwrt/bin/targets/*/*
         mv openwrt/.config zhlhlf/.config    
         zip -r openwrt-by-jczhl-$(date +"%Y-%m-%d").zip openwrt/bin/targets/*/*

    - name: 移动生成包至zhlhlf目录
      run: |
         mv $model-$repo_os-$repo_branch-by-jczhl.* zhlhlf

    - name: upload
      run: |
         curl -sL https://raw.githubusercontent.com/zhlhlf/text/refs/heads/main/upload/upload.sh | bash -s "${{ secrets.RCK }}" "${{ inputs.upload }}"
      
