name: Build OpenWrt

on:   
   workflow_dispatch:

    inputs:
      repo_url:
        description: 'repo_url'
        required: true
        default: 'https://github.com/openwrt/openwrt'

      repo_branch:
        description: 'repo_branch'
        required: false
        default: 'master'

      config:
        description: 'config'
        required: false
        default: '.config'

      diy_sh:
        description: 'diy_sh'
        required: false
        default: 'cd openwrt ; sh ../diy.sh'

      upload:
        description: '123 tyy2/short_time_files tyy2_crypt'
        required: false
        default: ''
        
env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 更改交换空间并link构建空间
      uses: zhlhlf/maximize-build-space@master
      with:
          swap-size-mb: 8192
                      
    - name: 获取本仓库源码
      uses: actions/checkout@main

    - name: 配置环境
      run: |
        sudo apt-get update
        sudo apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 python2.7 unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget curl swig rsync
       
    - name: 获取源码&替换config
      run: |
        git clone --depth 1 ${{ inputs.repo_url }} -b ${{ inputs.repo_branch }} openwrt
        rm -rf $GITHUB_WORKSPACE/openwrt/.config
        mv ${{ inputs.config }} openwrt/.config
        # git clone https://github.com/zhlhlf/jczhl-package openwrt/package/jczhl
 
    - name: 更新 feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: 安装 feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: 一系列可自定义配置
      run: |
        ${{ inputs.diy_sh }}
        
    - name: 获取软件包
      run: |
        mkdir zhlhlf
        cd openwrt   
        make defconfig
        cat .config
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: 编译
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "::set-output name=status::success"
                            
    - name: zip 打包
      run: |
         rm -rf openwrt/bin/targets/*/*/packages 
         mv openwrt/.config zhlhlf/.config    
         zip -r $model-$repo_os-$repo_branch-by-jczhl.zip openwrt/bin/targets/*/*/*

    - name: 移动生成包至zhlhlf目录
      run: |
         mv $model-$repo_os-$repo_branch-by-jczhl.* zhlhlf

    - name: upload
      run: |
         curl -sL https://raw.githubusercontent.com/zhlhlf/text/refs/heads/main/upload/upload.sh | bash -s "${{ secrets.RCK }}" "${{ inputs.upload }}"
      
